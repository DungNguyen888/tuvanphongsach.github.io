const fs = require('fs');
const path = require('path');
const cheerio = require('cheerio');
const sharp = require('sharp');

const rootDir = path.resolve(__dirname, '../');
const pagesDir = path.join(rootDir, 'pages');
const partialsDir = path.join(rootDir, 'partials');

const headerFile = path.join(partialsDir, 'header.html');
const footerFile = path.join(partialsDir, 'footer.html');

const STATIC_FILES = ['home.html', 'gioi-thieu.html', 'lien-he.html', 'dich-vu.html'];
const BASE_URL = 'https://tuvanphongsach.com';
const defaultImage = '/image/default.jpg';

const metaDescriptions = {
  'home.html': 'T∆∞ v·∫•n ph√≤ng s·∫°ch ƒë·∫°t chu·∫©n GMP, ISO. Thi·∫øt k·∫ø, thi c√¥ng, b·∫£o tr√¨ tr·ªçn g√≥i b·ªüi Tuvanphongsach.com - h∆°n 15 nƒÉm kinh nghi·ªám.',
  'gioi-thieu.html': 'Tuvanphongsach.com - Chuy√™n gia t∆∞ v·∫•n ph√≤ng s·∫°ch v·ªõi 15+ nƒÉm kinh nghi·ªám. ƒê·ªôi ng≈© k·ªπ s∆∞ t·∫≠n t√¢m, gi·∫£i ph√°p t·ªëi ∆∞u cho doanh nghi·ªáp.',
  'lien-he.html': 'Li√™n h·ªá Tuvanphongsach.com ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n ph√≤ng s·∫°ch mi·ªÖn ph√≠. H·ªó tr·ª£ thi·∫øt k·∫ø, thi c√¥ng, b·∫£o tr√¨ ƒë·∫°t chu·∫©n GMP, ISO.',
  'dich-vu.html': 'D·ªãch v·ª• ph√≤ng s·∫°ch tr·ªçn g√≥i: t∆∞ v·∫•n, thi·∫øt k·∫ø, thi c√¥ng, b·∫£o tr√¨ ƒë·∫°t chu·∫©n GMP, ISO. Gi·∫£i ph√°p t·ªëi ∆∞u t·ª´ Tuvanphongsach.com.'
};

// Load partials
function loadPartials() {
  const header = fs.readFileSync(headerFile, 'utf8');
  const footer = fs.readFileSync(footerFile, 'utf8');
  return { header, footer };
}

// T·ªëi ∆∞u JPEG g·ªëc
async function optimizeJpeg(inputPath) {
  const { dir, name, ext } = path.parse(inputPath);
  const outputPath = path.join(dir, `${name}-opt${ext}`);
  if (!fs.existsSync(inputPath)) {
    console.error(`[optimizeJpeg] File not found: ${inputPath}`);
    return null;
  }
  try {
    await sharp(inputPath)
      .jpeg({ quality: 70, mozjpeg: true })
      .toFile(outputPath);
    console.log(`[optimizeJpeg] Success: ${outputPath} created`);
    return outputPath.replace(rootDir, '').replace(/\\/g, '/');
  } catch (err) {
    console.error('[optimizeJpeg] Error:', err);
    return null;
  }
}

// Resize v√† chuy·ªÉn ·∫£nh sang WebP/AVIF
async function makeWebpAndAvif(inputPath, maxWidth, maxHeight, isIcon = false) {
  if (!fs.existsSync(inputPath)) {
    console.error(`[makeWebpAndAvif] File not found: ${inputPath}`);
    return { webp: null, avif: null, webpSmall: null, avifSmall: null };
  }
  const ext = path.extname(inputPath).toLowerCase();
  if (!['.jpg', '.jpeg', '.png'].includes(ext)) {
    console.log(`[makeWebpAndAvif] Skipped: ${inputPath} (unsupported format: ${ext})`);
    return { webp: null, avif: null, webpSmall: null, avifSmall: null };
  }

  try {
    const { dir, name } = path.parse(inputPath);
    const webpPath = path.join(dir, `${name}.webp`);
    const avifPath = path.join(dir, `${name}.avif`);
    const webpSmallPath = path.join(dir, `${name}-small.webp`);
    const avifSmallPath = path.join(dir, `${name}-small.avif`);

    let sharpInstance = sharp(inputPath).withMetadata();

    // T·∫°o phi√™n b·∫£n desktop
    if (maxWidth && maxHeight && !isIcon) {
      sharpInstance = sharpInstance.resize({ width: maxWidth, height: maxHeight, fit: 'inside' });
    }

    const webpQuality = isIcon ? 80 : 50;
    const avifQuality = isIcon ? 80 : 40;

    // T·∫°o t·ªáp .webp v√† .avif cho desktop
    await sharpInstance.clone().webp({ quality: webpQuality }).toFile(webpPath);
    await sharpInstance.clone().avif({ quality: avifQuality }).toFile(avifPath);

    // T·∫°o phi√™n b·∫£n mobile (resize nh·ªè h∆°n)
    let sharpInstanceSmall = sharp(inputPath).withMetadata();
    if (isIcon) {
      // Gi·ªØ nguy√™n k√≠ch th∆∞·ªõc cho icons
      sharpInstanceSmall = sharpInstanceSmall.resize({ width: 64, height: 64, fit: 'inside' });
    } else {
      // Resize nh·ªè h∆°n cho mobile
      sharpInstanceSmall = sharpInstanceSmall.resize({ width: Math.round(maxWidth * 0.6), height: Math.round(maxHeight * 0.6), fit: 'inside' });
    }

    // T·∫°o t·ªáp -small.webp v√† -small.avif cho mobile
    await sharpInstanceSmall.clone().webp({ quality: webpQuality }).toFile(webpSmallPath);
    await sharpInstanceSmall.clone().avif({ quality: avifQuality }).toFile(avifSmallPath);

    console.log(`[makeWebpAndAvif] Success: ${webpPath}, ${avifPath}, ${webpSmallPath}, ${avifSmallPath} created`);
    return {
      webp: webpPath.replace(rootDir, '').replace(/\\/g, '/'),
      avif: avifPath.replace(rootDir, '').replace(/\\/g, '/'),
      webpSmall: webpSmallPath.replace(rootDir, '').replace(/\\/g, '/'),
      avifSmall: avifSmallPath.replace(rootDir, '').replace(/\\/g, '/')
    };
  } catch (err) {
    console.error('[makeWebpAndAvif] Error:', err);
    return { webp: null, avif: null, webpSmall: null, avifSmall: null };
  }
}

// Convert <img> to <picture>
async function convertImages(html, pageName) {
  const $ = cheerio.load(html, { decodeEntities: false });
  const imgs = $('img');
  console.log(`[convertImages] Found ${imgs.length} <img> tags in ${pageName}`);
  if (imgs.length === 0) return html;

  for (let i = 0; i < imgs.length; i++) {
    const el = imgs[i];
    const src = $(el).attr('src');
    if (!src) {
      console.log(`[convertImages] Skipping: <img> without src in ${pageName}`);
      continue;
    }
    if (src.endsWith('.webp') || src.endsWith('.avif')) {
      console.log(`[convertImages] Skipping: Already optimized ${src} in ${pageName}`);
      continue;
    }
    console.log(`[convertImages] Processing: ${src} in ${pageName}`);
    const alt = $(el).attr('alt') || '';
    const realPath = path.join(rootDir, src);

    if (!fs.existsSync(realPath)) {
      console.warn(`[convertImages] H√¨nh ·∫£nh kh√¥ng t·ªìn t·∫°i: ${realPath}`);
      continue;
    }

    // X√°c ƒë·ªãnh k√≠ch th∆∞·ªõc resize d·ª±a tr√™n ng·ªØ c·∫£nh
    let maxWidth, maxHeight;
    const isIcon = src.includes('icons/');
    if (isIcon) {
      maxWidth = null;
      maxHeight = null;
    } else if ($(el).closest('.service-card').length > 0) {
      maxWidth = 400;
      maxHeight = 225;
    } else if (src.includes('about-us')) {
      maxWidth = 600;
      maxHeight = 400;
    } else if (pageName === 'gioi-thieu.html') {
      maxWidth = 800;
      maxHeight = 600;
    } else {
      maxWidth = 1200;
      maxHeight = 800;
    }

    const { webp, avif, webpSmall, avifSmall } = await makeWebpAndAvif(realPath, maxWidth, maxHeight, isIcon);
    const optimizedJpeg = await optimizeJpeg(realPath);

    if (webp && avif && webpSmall && avifSmall) {
      const width = maxWidth || $(el).attr('width') || '';
      const height = maxHeight || $(el).attr('height') || '';
      let imgClass = 'img-fluid';
      if ($(el).closest('.service-card').length > 0) {
        imgClass = 'card-img-top img-fluid';
      } else if ($(el).hasClass('banner-img')) {
        imgClass = 'banner-img img-fluid';
      }

      const pictureHtml = `
<picture>
  <source media="(max-width: 768px)" srcset="${avifSmall}" type="image/avif">
  <source media="(max-width: 768px)" srcset="${webpSmall}" type="image/webp">
  <source srcset="${avif}" type="image/avif">
  <source srcset="${webp}" type="image/webp">
  <img src="${optimizedJpeg || src}" alt="${alt}" class="${imgClass}" ${width ? `width="${width}"` : ''} ${height ? `height="${height}"` : ''} loading="lazy" fetchpriority="${i < 3 ? 'high' : 'auto'}">
</picture>`;
      $(el).replaceWith(pictureHtml);
      console.log(`[convertImages] Converted ${src} to <picture> in ${pageName}`);
    }
  }
  return $.html();
}

// Build Static Pages
async function buildStaticPages() {
  if (!fs.existsSync(pagesDir)) {
    console.log('‚ùå Th∆∞ m·ª•c pages/ kh√¥ng t·ªìn t·∫°i');
    return;
  }

  for (const file of STATIC_FILES) {
    const filePath = path.join(pagesDir, file);
    if (!fs.existsSync(filePath)) {
      console.log(`‚ùå Kh√¥ng t√¨m th·∫•y ${file}`);
      continue;
    }
    let raw = fs.readFileSync(filePath, 'utf8');
    const $raw = cheerio.load(raw, { decodeEntities: false });
    const h1Text = $raw('h1').first().text().trim() || 'Untitled';
    const styles = $raw('head style').html() || '';
    $raw('title, meta:not([name="charset"]), script[type="application/ld+json"]').remove();
    raw = $raw.html();

    let { header, footer } = loadPartials();

    const $doc = cheerio.load('<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"></head><body></body></html>', { decodeEntities: false });
    $doc('head').append(`
      <link rel="stylesheet" href="/style.css">
      <link rel="stylesheet" href="/assets/bootstrap/bootstrap.min.css">
    `);
    if (styles) {
      $doc('head').append(`<style>${styles}</style>`);
    }
    $doc('head').append(`<title>${h1Text}</title>`);

    $doc('body').prepend(header);
    $doc('body').append(raw);
    $doc('body').append(footer);

    let finalHtml = $doc.html();
    finalHtml = await convertImages(finalHtml, file);

    const outName = file === 'home.html' ? 'index.html' : file;
    const outPath = path.join(rootDir, outName);
    fs.writeFileSync(outPath, finalHtml, 'utf8');
    console.log(`‚úÖ Build [${file}] => /${outName}`);
  }

  injectMeta();
  injectOpenGraph();
  injectBreadcrumbAuto();

  console.log('\nüéØ Ho√†n t·∫•t build trang tƒ©nh!\n');
}

// Inject Meta
function injectMeta() {
  STATIC_FILES.forEach(file => {
    const outName = file === 'home.html' ? 'index.html' : file;
    const filePath = path.join(rootDir, outName);
    if (!fs.existsSync(filePath)) return;

    let html = fs.readFileSync(filePath, 'utf8');
    const $ = cheerio.load(html, { decodeEntities: false });

    $('meta[name="viewport"]').remove();
    $('meta[name="description"]').remove();

    $('head').prepend('<meta name="viewport" content="width=device-width, initial-scale=1.0">');
    const description = metaDescriptions[file] || 'Tuvanphongsach.com - D·ªãch v·ª• T∆∞ V·∫•n Ph√≤ng S·∫°ch ƒë·∫°t chu·∫©n GMP, ISO.';
    $('head').append(`<meta name="description" content="${description}">`);

    fs.writeFileSync(filePath, $.html(), 'utf8');
    console.log(`‚úÖ [Meta] => ${outName}`);
  });
}

// Inject Open Graph
function injectOpenGraph() {
  STATIC_FILES.forEach(file => {
    const outName = file === 'home.html' ? 'index.html' : file;
    const filePath = path.join(rootDir, outName);
    if (!fs.existsSync(filePath)) return;

    let html = fs.readFileSync(filePath, 'utf8');
    const $ = cheerio.load(html, { decodeEntities: false });

    if ($('meta[property^="og:"]').length === 0) {
      const titleMatch = html.match(/<title>([\s\S]*?)<\/title>/);
      const title = titleMatch ? titleMatch[1].trim() : 'Tuvanphongsach.com';
      const descMatch = html.match(/<meta name="description" content="([^"]*)"/);
      const description = descMatch ? descMatch[1] : metaDescriptions[file] || 'Tuvanphongsach.com - D·ªãch v·ª• T∆∞ V·∫•n Ph√≤ng S·∫°ch.';
      const matchImg = html.match(/<img[^>]*src="([^"]*)"/);
      const img = matchImg ? matchImg[1] : defaultImage;
      const ogUrl = BASE_URL + '/' + outName;

      const ogTags = `
<meta property="og:title" content="${title}">
<meta property="og:description" content="${description}">
<meta property="og:image" content="${img}">
<meta property="og:url" content="${ogUrl}">`;
      $('head').append(ogTags);
    }

    fs.writeFileSync(filePath, $.html(), 'utf8');
    console.log(`‚úÖ [OG] => ${outName}`);
  });
}

// Inject Breadcrumb
function injectBreadcrumbAuto() {
  STATIC_FILES.forEach(file => {
    const outName = file === 'home.html' ? 'index.html' : file;
    const filePath = path.join(rootDir, outName);
    if (!fs.existsSync(filePath)) return;

    let html = fs.readFileSync(filePath, 'utf8');
    const $ = cheerio.load(html, { decodeEntities: false });

    $('script[type="application/ld+json"]').filter((i, el) => {
      return $(el).html().includes('"BreadcrumbList"');
    }).remove();

    const itemList = [{
      "@type": "ListItem",
      "position": 1,
      "name": "Trang ch·ªß",
      "item": BASE_URL + "/"
    }];

    if (outName !== 'index.html') {
      const name = $('title').text().trim() || outName.replace('.html', '');
      itemList.push({
        "@type": "ListItem",
        "position": 2,
        "name": name,
        "item": BASE_URL + '/' + outName
      });
    }

    const breadcrumbJSON = {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": itemList
    };
    const snippet = `
<script type="application/ld+json">
${JSON.stringify(breadcrumbJSON, null, 2)}
</script>`;

    $('head').prepend(snippet);
    fs.writeFileSync(filePath, $.html(), 'utf8');
    console.log(`‚úÖ [Breadcrumb Auto] => ${outName}`);
  });
}

//buildStaticPages().catch(err => console.error('‚ùå L·ªói build trang:', err));
module.exports = { buildStaticPages };